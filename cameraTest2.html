<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Stream Receiver</title>
    <style>
        #video {
            width: 640px;
            height: 360px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>WebRTC Stream</h1>
    <video id="video" autoplay playsinline></video>
    <button id="start">Start Streaming</button>

    <script>
        const videoElement = document.getElementById("video");
        const startButton = document.getElementById("start");
        let pc = null;

        async function startStreaming() {
            if (pc) {
                console.log("üîπ WebRTC already started");
                return;
            }

            pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
            });

            const offerOptions = {
                offerToReceiveAudio: false,
                offerToReceiveVideo: true
            };

            try {
                const offer = await pc.createOffer(offerOptions);
                await pc.setLocalDescription(offer);

                const ws = new WebSocket("ws://localhost:8765");

                ws.onopen = () => {
                    console.log("üîπ WebSocket connected, sending offer...");
                    ws.send(JSON.stringify(offer));
                };

                ws.onmessage = async (event) => {
                    console.log("üîπ Received WebRTC Answer");
                    const answer = JSON.parse(event.data);
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                };

                pc.ontrack = (event) => {
                    console.log("‚úÖ Video stream received!");
                    videoElement.srcObject = event.streams[0];
                };

                pc.oniceconnectionstatechange = () => {
                    console.log(`ICE Connection State: ${pc.iceConnectionState}`);
                };

                // Get video stream with higher constraints
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                };

                navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
                    const videoTrack = stream.getVideoTracks()[0];
                    pc.addTrack(videoTrack, stream);

                    // Adjust the bitrate (2 Mbps for max)
                    const sender = pc.getSenders().find(sender => sender.track.kind === 'video');
                    const parameters = sender.getParameters();
                    if (!parameters.encodings) {
                        parameters.encodings = [{}];
                    }
                    parameters.encodings[0].maxBitrate = 2 * 1000 * 1000; // 2 Mbps
                    sender.setParameters(parameters);
                });

            } catch (error) {
                console.error("‚ùå WebRTC Error:", error);
            }
        }

        startButton.addEventListener("click", startStreaming);
    </script>
</body>
</html>
